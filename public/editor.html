<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Visual de Emails</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/style/styles.css">
</head>

<body>
    <div class="bg-video">
        <video autoplay muted loop playsinline>
            <source src="assets/imgs/banner.mp4" type="video/mp4">
        </video>
    </div>

    <div class="editor-container">
        <!-- Toolbar -->
        <header class="editor-toolbar">
            <div class="toolbar-left">
                <h1 class="editor-title">
                    <i class="fas fa-envelope"></i>
                    Editor Visual de Emails
                </h1>
            </div>
            <div class="toolbar-center">
                <div class="history-controls" style="margin-right: 20px; display: flex; gap: 10px;">
                    <button class="toolbar-btn" id="undoBtn" title="Desfazer (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="toolbar-btn" id="redoBtn" title="Avançar (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="view-toggle">
                    <button class="toggle-btn active" data-view="desktop">
                        <i class="fas fa-desktop"></i>
                        Desktop

                    </button>
                    <button class="toggle-btn" data-view="mobile">
                        <i class="fas fa-mobile-alt"></i>
                        Mobile
                    </button>
                </div>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-btn" id="importBtn">
                    <i class="fas fa-file-import"></i>
                    Importar Template
                </button>
                <button class="toolbar-btn primary" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Exportar HTML
                </button>
                <button class="toolbar-btn success" id="sendEmailBtn">
                    <i class="fas fa-paper-plane"></i>
                    Enviar Email
                </button>
            </div>
        </header>

        <!-- Main Editor Area -->
        <div class="editor-main">
            <!-- Left Sidebar - Component Library -->
            <aside class="component-library">
                <div class="library-header">
                    <h2>Componentes</h2>
                </div>
                <div class="library-content">
                    <div class="component-category">
                        <h3>Layout</h3>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-type="header">
                                <i class="fas fa-heading"></i>
                                <span>Header</span>
                            </div>
                            <div class="component-item" draggable="true" data-type="footer">
                                <i class="fas fa-shoe-prints"></i>
                                <span>Footer</span>
                            </div>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Conteúdo</h3>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-type="text">
                                <i class="fas fa-align-left"></i>
                                <span>Texto</span>
                            </div>
                            <div class="component-item" draggable="true" data-type="heading">
                                <i class="fas fa-heading"></i>
                                <span>Título</span>
                            </div>
                            <div class="component-item" draggable="true" data-type="button">
                                <i class="fas fa-square"></i>
                                <span>Botão</span>
                            </div>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Mídia</h3>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-type="image">
                                <i class="fas fa-image"></i>
                                <span>Imagem</span>
                            </div>
                            <div class="component-item" draggable="true" data-type="social">
                                <i class="fas fa-share-alt"></i>
                                <span>Redes Sociais</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center - Canvas Preview -->
            <main class="editor-canvas">
                <div class="canvas-wrapper">
                    <div class="canvas-container" id="canvasContainer">
                        <iframe id="previewFrame" frameborder="0"></iframe>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar - Properties Panel -->
            <aside class="properties-panel">
                <div class="panel-header">
                    <h2>Propriedades</h2>
                </div>
                <div class="panel-content" id="propertiesContent">
                    <div class="panel-empty-state">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Selecione um elemento para editar suas propriedades</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Importar Template HTML</h2>
                <button class="modal-close" onclick="closeImportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="import-options">
                    <div class="import-option">
                        <h3>Colar HTML</h3>
                        <textarea id="htmlInput" placeholder="Cole o código HTML aqui..." rows="15"></textarea>
                    </div>
                    <div class="import-option">
                        <h3>Ou carregar arquivo</h3>
                        <input type="file" id="fileInput" accept=".html" style="display: none;">
                        <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file-upload"></i>
                            Escolher Arquivo
                        </button>
                        <p class="file-name" id="fileName"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeImportModal()">Cancelar</button>
                <button class="btn-primary" onclick="importTemplate()">
                    <i class="fas fa-check"></i>
                    Importar
                </button>
            </div>
        </div>
    </div>

    <!-- Send Email Modal -->
    <div class="modal" id="sendEmailModal"
        style="display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);">
        <div class="modal-content"
            style="width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header"
                style="border-bottom: 1px solid rgba(255,255,255,0.1); padding: 1.5rem 1.5rem 1rem; background: rgba(0,0,0,0.3);">
                <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-paper-plane" style="color: #00ffd0;"></i>
                    Enviar Email
                </h2>
                <button class="modal-close" onclick="closeSendEmailModal()"
                    style="background: none; border: none; color: #aaa; font-size: 1.5rem; cursor: pointer; padding: 0 10px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem; max-height: 60vh;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="emailSubject"
                        style="display: block; padding: 8px 0; font-weight: 500; color: #d0d0d0; font-size: 0.9em;">Assunto
                        *</label>
                    <input type="text" id="emailSubject" class="form-control" placeholder="Assunto do email" required
                        style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff;">
                </div>

                <div class="sender-info"
                    style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3
                        style="margin-top: 0; margin-bottom: 15px; font-size: 1rem; color: #aaa; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-user" style="color: #00ffd0;"></i>
                        Remetente
                    </h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label style="font-size: 0.9rem; color: #bbb;">De:</label>
                            <span id="senderInfo"
                                style="font-weight: 500; font-size: 1.1rem; color: #f0f0f0;">Carregando...</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 0.9rem; color: #bbb;">Responder para:</label>
                            <span id="replyToInfo" style="font-size: 1.1rem; color: #f0f0f0;">Carregando...</span>
                        </div>
                    </div>
                </div>

                <div class="recipients-info"
                    style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px;">
                    <h3
                        style="margin-top: 0; margin-bottom: 15px; font-size: 1rem; color: #aaa; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-users" style="color: #00ffd0;"></i>
                        Destinatários
                    </h3>
                    <div id="recipientsList"
                        style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                        Carregando...
                    </div>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; gap: 0.75rem; background: rgba(0,0,0,0.2);">
                <button class="btn-secondary" onclick="closeSendEmailModal()"
                    style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #fff; cursor: pointer; transition: all 0.2s;">
                    Cancelar
                </button>
                <button class="btn-success" onclick="sendEmail()"
                    style="padding: 8px 20px; background: #00ffd0; border: none; border-radius: 4px; color: black; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                    <i class="fas fa-paper-plane"></i>
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Estilos para a mensagem de sucesso */
        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #00ffd0;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .success-message i {
            font-size: 1.5rem;
            color: #00ffd0;
        }

        .success-message h4 {
            margin: 0 0 5px 0;
            color: #e0e0e0;
        }

        .success-message p {
            margin: 0;
            font-size: 0.9rem;
            color: #aaa;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilização da barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>

    <!-- Scripts -->
    <script src="assets/src/editor/component-registry.js"></script>
    <script src="assets/src/editor/template-parser.js"></script>
    <script src="assets/src/editor/history-manager.js"></script>
    <script src="assets/src/editor/html-exporter.js"></script>
    <script src="assets/src/editor/editor-canvas.js"></script>
    <script src="assets/src/editor/properties-panel.js"></script>
    <script src="assets/src/editor/component-library.js"></script>
    <script src="assets/src/editor/drag-drop-manager.js"></script>
    <script src="assets/src/editor/responsive-manager.js"></script>
    <script src="assets/src/editor/editor-main.js"></script>
    <script>
        // Armazenar dados do formulário principal
        let formData = {
            senderName: '',
            senderEmail: '',
            showSenderEmail: false,
            recipients: ''
        };

        // Carregar dados do formulário principal quando o editor for aberto
        document.addEventListener('DOMContentLoaded', () => {
            // Tentar recuperar os dados do localStorage
            const savedData = localStorage.getItem('emailFormData');
            if (savedData) {
                formData = JSON.parse(savedData);

                // Atualizar as informações no modal imediatamente se o modal já estiver aberto
                if (document.getElementById('sendEmailModal').style.display === 'flex') {
                    updateEmailModalInfo();
                }
            }
        });

        // Função para atualizar as informações do remetente e destinatários no modal
        function updateEmailModalInfo() {
            // Atualizar informações do remetente
            const senderInfo = document.getElementById('senderInfo');
            const replyToInfo = document.getElementById('replyToInfo');
            const recipientsList = document.getElementById('recipientsList');

            // Formatar e exibir informações do remetente
            const senderDisplay = formData.senderName || 'Sem nome';
            const emailDisplay = formData.senderEmail || 'noreply@exemplo.com';

            if (senderInfo) {
                senderInfo.textContent = `"${senderDisplay}" <${emailDisplay}>`;
            }

            // Exibir email para resposta (reply-to)
            if (replyToInfo) {
                if (formData.showSenderEmail && formData.senderEmail) {
                    replyToInfo.textContent = formData.senderEmail;
                    replyToInfo.style.color = '#00ffd0';
                    replyToInfo.style.fontWeight = '500';
                } else {
                    replyToInfo.textContent = 'Não configurado';
                    replyToInfo.style.color = '#ff6b6b';
                    replyToInfo.style.fontStyle = 'italic';
                }
            }

            // Exibir lista de destinatários
            if (recipientsList && formData.recipients) {
                const emails = formData.recipients.split(',').map(e => e.trim()).filter(e => e);
                if (emails.length > 0) {
                    recipientsList.innerHTML = emails.map(email =>
                        `<div style="padding: 4px 8px; margin: 2px 0; background: rgba(255,255,255,0.05); border-radius: 4px; display: flex; align-items: center;">
                            <i class="fas fa-user" style="margin-right: 8px; color: #00ffd0;"></i>
                            ${email}
                         </div>`
                    ).join('');
                } else {
                    recipientsList.innerHTML = '<div style="color: #bbb; font-style: italic; font-size: 0.9em;">Nenhum destinatário adicionado</div>';
                }
            }
        }

        // Open send email modal
        document.getElementById('sendEmailBtn').addEventListener('click', () => {
            const modal = document.getElementById('sendEmailModal');
            modal.style.display = 'flex';
            // Impedir rolagem do corpo quando o modal estiver aberto
            document.body.style.overflow = 'hidden';
            // Atualizar as informações no modal
            updateEmailModalInfo();
            // Focar no campo de assunto quando o modal abrir
            document.getElementById('emailSubject').focus();
        });

        // Close send email modal
        function closeSendEmailModal() {
            const modal = document.getElementById('sendEmailModal');
            modal.style.display = 'none';
            // Restaurar rolagem do corpo
            document.body.style.overflow = 'auto';
        }

        // Função para validar email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        // Send email function
        async function sendEmail() {
            const subject = document.getElementById('emailSubject').value.trim();

            if (!subject) {
                alert('Por favor, informe o assunto do email.');
                document.getElementById('emailSubject').focus();
                return;
            }

            // Validar emails dos destinatários
            const recipients = formData.recipients.split(',').map(email => email.trim()).filter(email => email);
            const invalidEmails = recipients.filter(email => !validateEmail(email));

            if (invalidEmails.length > 0) {
                alert(`Os seguintes emails são inválidos: ${invalidEmails.join(', ')}`);
                return;
            }

            // Obter o conteúdo HTML do iframe de visualização
            const emailContent = document.getElementById('previewFrame').contentDocument.documentElement.outerHTML;

            // Mostrar indicador de carregamento
            const sendBtn = document.querySelector('#sendEmailModal .btn-success');
            const originalBtnText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const response = await fetch('/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipients: formData.recipients,
                        senderName: formData.senderName,
                        senderEmail: formData.senderEmail,
                        showSenderEmail: formData.showSenderEmail,
                        subject,
                        message: emailContent
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Mostrar mensagem de sucesso
                    const successMessage = document.createElement('div');
                    successMessage.className = 'success-message';
                    successMessage.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Emails enviados com sucesso!</h4>
                            <p>Sucessos: ${result.stats.success}, Falhas: ${result.stats.fail}</p>
                        </div>
                    `;

                    // Inserir antes do botão de enviar
                    const modalFooter = document.querySelector('#sendEmailModal .modal-footer');
                    modalFooter.insertBefore(successMessage, modalFooter.firstChild);

                    // Fechar o modal após 3 segundos
                    setTimeout(() => {
                        closeSendEmailModal();
                        // Remover a mensagem de sucesso
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Erro ao enviar emails');
                }
            } catch (error) {
                console.error('Erro ao enviar email:', error);
                alert(`Erro ao enviar emails: ${error.message}`);
            } finally {
                // Restaurar o botão
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalBtnText;
            }
        }

        // Fechar o modal ao clicar fora dele
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('sendEmailModal');
            if (event.target === modal) {
                closeSendEmailModal();
            }
        });

        // Fechar com a tecla ESC
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeSendEmailModal();
            }
        });
    </script>
</body>

</html>